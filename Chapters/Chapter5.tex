% Chapter 5

\chapter{Time Series} % Main chapter title

\label{Chapter5} % For referencing the chapter elsewhere, use \ref{Chapter5} 

\lhead{Chapter 5. \emph{Time Series}} % This is for the header on each page - perhaps a shortened title

%----------------------------------------------------------------------------------------

This chapter will use time series analysis to generate models to make forecasts for futures prices in various national stock market indices. Firstly three base systems will be considered, these are simple concepts and will be used as a bench mark against which the following time series models will be compared, and if they can't produce superior results won't be considered further. the base systems are the naive method which simply uses the previous value for the forecast of the next value, the average method in which the forecast is simply the mean of the pervious values and the drift method. The drift method is the average change encountered in the historical data and is equivalent to drawing a striaght line between the first and last observation. Subsequent time series models are developed using exponential smoothing methods, ARIMA techniques and finally hybrid methods.

\section{Base results}
Three base systems - mean, naive and drift were used to generate results as a starting point from which subsequent time series models can be compared. 

Figure \ref{fig:chp5_ts_dax} shows the three methods being applied to a data set derived from the German Dax. The models were trained on the first 3000 observations and tested on the remaining 528. The results of applying these simple models against the test data can be seen in Table \ref{tab:chp_ts:sma}.

%label - tab:chp_ts:sma
\input{Tables/chp_ts_sma.tex}

Figure \ref{fig:chp5_ts_dax} is a plot of the forecast from these models generated against the training set and forecasting the closing price at the end of the test period. The Naive and Drift algorithms forecast similar values while the Mean method produces a markedly lower value.

\begin{figure}[tbh]
\centering
\includegraphics{Figures/chp_ts_dax1}
\caption[Results of simple modelling methods.]{Results of simple modelling methods.}
\label{fig:chp5_ts_dax}
\end{figure}

Figure \ref{fig:chp5_ts_dax_act} is the same as Figure \ref{fig:chp5_ts_dax} except the actual data encountered during the foecast period has been added.

\begin{figure}[tbh]
\centering
\includegraphics{Figures/chp_ts_dax1_plus_act_data}
\caption[Results of simple modelling methods and actual data.]{Results of simple modelling methods with actual data in forecast period added.}
\label{fig:chp_ts_dax_act}
\end{figure}

\section{Exponential Smoothing}

Using Rob J Hyndman's forecast package and the ets() function, a variety of exponential smoothing methods can be applied to sample data \citep{Hyndman08automatictime}. Table \ref{tab:tax_em} lists fifteen possibilities when one combines trend and seasonality. In fact Hyndman extends this further by allowing the error term to be either added or multiplied against the results. 

\begin{table}[ht]
\centering
\caption[Taxonomy of exponential smoothing methods.]{of exponential smoothing methods.} 
\label{tab:tax_em}
\begin{tabular}{lccc}
  \toprule 
            & \multicolumn{3}{c}{Seasonal Component} \\
  \cmidrule(r){2-4}
  Trend     & N      & A          & M       \\ 
  Component &(None)  &(Additive)  & (Multiplicative)  \\
  \midrule 
  N (None) & (N,N)&(N,A)&(N,M)  \\ 
  A (Additive) & (A,N)&	(A,A)&(A,M)  \\ 
  Ad (Additive damped) &(Ad,N)&(Ad,A)&(Ad,M) \\ 
  M (Multiplicative) &(M,N)&(M,A)&(M,M)  \\ 
  Md (Multiplicative damped) &(Md,N)&(Md,A)&(Md,M) \\ 
   \bottomrule \end{tabular}
\end{table}

Note - Hymndman: hard to beat the ets model, 37 mins.


% ------ NEW PAGE --------------------------
\newpage
\section{ARIMA Models}

The process of fitting an ARIMA model to a time series involves the following general steps:

\begin{enumerate}
\item Plot the data to get a general feel for the time series and to establish if it is stationary.
\item Stabilize any variance in the data with a transformation process such as the Box-Cox method.
\item Arima models work with stationary data, so if necessary, take differences of the data until it is stationary.
\item Examine the autocorrelation and partial auto-correlation (ACF/PACF) plots in order to determine if an AR(p) or MA(q) model is appropriate.
\item Test the chosen model(s), using the AICc to determine if a better model is available.
\item Check the residuals from the best model by plotting the ACF, and doing a portmanteau test on them. If the results from these tests do not look like white noise, a modified model may be required.
\item Finally, once the residuals have a similar pattern to white noise, the model can be used to generate forecasts.
\end{enumerate}


In recent years automatic forecasting algorithms have become available and widely used \citep{Hyndman08automatictime}. These are necessary in a variety of circumstances, especially when organisations are faced with the need to repeatedly carry out a large number of forecasts and the human effort required renders manual means impractical. The auto.arima() function found in R's \textquotedblleft forecast" package is an example of an automatic algorithm for arima models. This function automates steps 3, 4, and 5 of those outlined previously in the general steps required for arima modelling. In the following sections, the general steps are followed in order to generate an arima model manually then the automatic algorithm is used for comparison purposes.

\subsection{Data Exploration}

The first step, as always is to explore the data. Figure \ref{fig:chp_ts_ftse_2000_13} shows the UK's FTSE 100 index between the years 2000 to 2013.

\begin{figure}[tbh]
\centering
\includegraphics{Figures/chp_ts_ftse_2000-13}
\caption[FTSE 2000-13.]{UK's FTSE 100 index between the years 2000 to 2013.}
\label{fig:chp_ts_ftse_2000_13}
\end{figure}

\subsection{Box Cox Transformation}
The variance within the time series is relatively uniform and thus this data set doesn't need stabilizing with regard to this. 

\subsection{Difference}
Clearly the FTSE 100 over this time period exhibits marked non-stationariness and requires adjusting accordingly. The top plot in Figure \ref{fig:chp_ts_ftse_2000_13_diff_acf} shows the FTSE data set after the first differences have been taken.  The resulting data set is now stationary.

%\begin{figure}[tbh]
%\centering
%\includegraphics{Figures/chp_ts_ftse_2000-13_diff}
%\caption[FTSE 2000-13 Diff.]{FTSE 2000-13 Diff.}
%\label{fig:chp_ts_ftse_2000_13_diff}
%\end{figure}

\subsection{Examine ACF / PACF}
After generating a stationary data set the next stage is to plot the ACF and PACF in order to help in the model selection process. The ACF and PACF for the FTSE data set can be seen in the lower part of Figure \ref{fig:chp_ts_ftse_2000_13_diff_acf}. 

WHAT CAN WE CONCLUDE?

\begin{figure}[tbh]
\centering
%\includegraphics[width=15cm]{Figures/chp_ts_ftse_2000-13_diff_acf}
\includegraphics[width=14cm, height=12cm]{Figures/chp_ts_ftse_2000-13_diff_acf}
\caption[FTSE 2000-13 ACF / PACF.]{FTSE 2000-13 Diff and ACF / PACF.}
\label{fig:chp_ts_ftse_2000_13_diff_acf}
\end{figure}

\subsection{Try the chosen model(s)}
The next step is to try the chosen model along with a few viable alternatives. The Aic value is typically used as a measure of how well the model fits the data. Table \ref{tab:chp_ts:arima_res_r} shows the accuracy measures from a selection of arima models.

%label - tab:chp_ts:arima_res_r
\input{Tables/chp_ts_arima_res_r.tex}

\subsection{Residuals from the chosen model}
The residuals from good arima models don't display autocorrelation. To check this the ACF plot from the chosen arima model is shown in Figure \ref{fig:chp_ts_ftse_2000_13_acf_residuals}.

\begin{figure}[!tbh]
\centering
\includegraphics{Figures/chp_ts_ftse_2000-13_acf_residuals}
\caption[FTSE 2000-13 ACF of residuals.]{FTSE 2000-13 ACF of residuals.}
\label{fig:chp_ts_ftse_2000_13_acf_residuals}
\end{figure}

% Box Ljung test
Table \ref{tab:chp_ts:arima_res_rbox_l} lists the results of the Box-Ljung portmanteau test. A large p-value is indicative of white noise and is the desirable situation for a good arima model.

%label - tab:chp_ts:arima_res_rbox_l
\input{Tables/chp_ts_arima_res_r_box_l.tex}



\subsection{Calculate forecast}


\subsection{Automatic Arima Modelling}

Explain how it is done.

Table \ref{tab:chp_ts:arima1} results from from ts1 code - Arima1 - ARIMA(3,1,3)
%label - tab:chp_ts:arima1
\input{Tables/chp_ts_arima1.tex}

% ---------------------------------------------------------------
\section{Hybrid Arima Models}
Figure \ref{fig:chp_ts_rm_arima} shows the Rapid Miner process used to generate Arima models. The various components are as follows:

\begin{itemize}
\item Read CSV - reads in the appropriate data set.
\item Select Attribute (1) - selects the attribute that will be processed in the following steps.
\item Rename - renames the attribute selected in Select Attribute (1) to \textquotedblleft attr1" which is then used in the est of the steps. This component is used to make it easy to change the attribute without having to rename all the subsequent steps.
\item Moving Average - calculates a moving average of the time series (see section \ref{sec:chp2_sma} for details.) This provides the q in ARIMA(p,d,q) models.
\item Differentiate - calculates the difference in the time series and provides the d in ARIMA(p,d,q) models.
\item Lag - creates lag variables which are values of the attribute (the attribute itself, the moving average or the difference value) at earlier points in the time series.
\item Select Attribute (2) - selects the attributes that will be passed to the validation block. Attributes regaring today's values are removed because we are building a model to calculate them and don't want to \textquotedblleft peak" at them before the model is built.
\item Set Role - sets an attribute as the label to be predicted.

\end{itemize}

\begin{figure}[!tbh]
\centering
\includegraphics[width=12cm]{../Figures/chp_ts_rm_arima}
\caption[Rapid Miner Arima Process]{Rapid Miner Arima Process.}
\label{fig:chp_ts_rm_arima}
\end{figure}

Questions - should we pass the diff values ot the model - just to flatten the series?

TO DO - auto forecast - on window - does model change? prediction any good? ets and arima ...

